___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "displayName": "Taboola Pixel",
  "description": "Use the Taboola Pixel template to easily track your campaigns' performance, set up customized conversions and to build custom audiences for retargeting.",
  "categories": ["MARKETING","CONVERSION_TRACKING", "ADVERTISING"],
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1RhYm9vbGEtUGl4ZWwtU2ltby1BaGF2YQ==",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAADhtJREFUeAHtXQtwFdUZPufsvXlAgEB4lInYgDysilqk4gswNwkYX+h0YlXqYGtyE7FO7WjrYDs105dT7Ew7owWSoMUnaGyniMJIkgvGgqJCq4A6KA1QfPA2JpD72j399sINuze7957dvfcmyu7kzp495z//+c7/n8d//nN2Q4h7uRJwJeBKwJWAKwFXAq4EXAm4EnAl4ErAlYArAVcCrgRcCbgScCWQFQnQdJYyovLeod3hkI9zPotyMoFQUkI4H8MpzSecDDpVVielpBPhTsR1EMq3E0Z3MCXn3WDgr3vTiceMV67Pfw7nZAahynmEUPzIRGAZwgkpIITjRz24d1NCu4HvEJ53g2Y36rS50Dus7cD6Px0342013rECvD7/NAC7jhM+B4VfBuAAb++CYt5HZV9G/ZvDbUsRTt81qKJ2elThtxCF3wCs59rmTEmYcNrOGFnHJbo2vL7xI9u8kNG2AmIViiq/Q2XmOgFgnpe2MkofDQUa15vTJE9BT6R5ZXXXK0R+AC18VnJqe6loNGsJ9S6y22AsKyCntOZ8qO23qNzN9iBbzrWReSR/qKXhYys5c8oXfofLkUb0yKus5LNFS6lCCX+eecivg+uXd1jhIVkh9vpqakC/BpU630o+h7QlXOE13gmXhOSObZtFeKGRLOJEXgXa8SL0aaBRG/KFmFfulsZfckDp2LZNlKdQD6ivr2e/b9+/GN34flHGmaAD2KemTmI1WxsbI0b8z6+qz/n48KdPYlicb5SerTjK6COh1sZfUorZMcWVUgFnVf0s/+CR7lUYcm5MwStLybT123l513+y7rGQtsCJlffm7g0F18Lq8mnj+ysM4a86OzfvzkSciXhYYkTi88HDXUsHjvBVdLx8Xyi4Qp1g41jV8L5gz1MDRfgxlJzfui8YfCKO0eyeVAHe0pofow8tMMvcX/EQ+K25ZbUPx8tXw8D5g/jzQLmrQ6HXV/ujZHh6W1EiUU65fyqX+Ra0uPzEtIHxTKOE0hmEMcy38tvAaXv9kdH6UHqCMu/0cOuSD43KMQct86cHrvDVqnAPTL+/YWEF42OACj8Gkw8icuR5oJxmNCkb9oDccv91iqy8YqQxN86eBKhEbgq3Ll+dmNuwB0D4ixIJbT4HGSXPwhfUJhG2F0t4WabyBK6QmVjM3YlJM+4fssk+bdmAkz7DKWuTqLyXKB6lFychGMOdD8NcJj8H2j4K6NMD8sv9V0Vl5Y00VO1dbw678cRrjZ8b8SqovHdUKBT8O5Qw0yg9a3GUvuP10nlJcQaD/4ASHK+oPUy6oqet4U1t3fpYQbKsVGsJ7IQx1n1QODKn1KxSKs/udY8dGlNUoPqR3rVTRjryxHAWeX0pcY4sUB2NW52WKSvKPYk8+igABL5EIqvPEqO1h5qXdKfKt7/5zz1E8vhhzSipaDORLkmSXxgnZenA2Ue2OgXkzl04Efb0OGeVpVt6Whv/Jcoj0rrs33BxBETp00cHnC3LNonyiwQaVf/ORlF6IzpYa2Nzy2oma9N0CiDRaJk20U4YfvKVlvNR+oLlPA4z2MJJiOrgc3QpnMzWMtApALYqNlScXRJjwq0qXhLlXDcxxeMzebeF0yM5xon9A91krlMAhoKxTis9unjsDqs85o2s+Cjb84AtnMN8HzrFCdd6sVY+egVQMkqbaDlMyfE9K+qDVvM1N98iwxz9ymo+2/RwD9jGSUiX7XKREfvMRdr8egVwMlqbaDVMOT1mNU+cHl1T3ajPygUv/VG7BWHh5BAnN1cAHLwOewC3XTG0jSz2AAc4HfZUyHiEVvmJPcBwp0mbIXkY7dj2BZ9a1i4HOLF6cwQT/g5tft0DdtCOaBNthIfZyHMqi35stM9HKKd9nFzfgoVK0xBBfThndPrSKQDDgCMFoAnbrhjyjjwNK7MhZzj5cCfoYOof1ObXKQCDgIMxPMZ2yNX19YYeVm2hieFRVQsLYAXlJsZn8Nk+TkLynOBCDzBXAEanfU6YQ4hs8xsHzrPKo/tY+AKreRzR28V5JHKho3KRGZbi51oeiT3AsRua8ugV2gJEwopCdatDkTxOaWzh5PxKp+UqVO8p0ClA8vDXHRfAya1WecBJdbvVPE7psZNpeRMfJuRtTsv1MN6m5aFTgHqsDjbW/7QE1sN8Vr6v7lLRfHll/lLMPd8VpU8j3WxLOCtqy5zihAW7G55i3TCvU0CscpS0OqwklbncMGbOA4NT8Rl54y+GoCU2pKLLUDqVSXSZCM7h5f5h2KZd6hQHLCBd61f59VEAJ+xxxwURfvHRaOf6wWU/HWPGK7+y+qyvuo61A9QkM5pMx6stWgTncZlvTBNOHBbWX4arOhzCbYNF49OT2nmiPfA+PYXjI+0S8ewmLMpkTkvAqQKVn59l0zNZBYLwcq6I4fSw/xKZAqdcgrhyCP6H8BLnJMsslEZJSySwXN3a1F2GCsBJs2sURV6no3QfHElAoqQsGFjeZ+fPUAFqSTiW+BZOAsxwVGrGM1NgRB8b6DgpeROt39A87zMHxGWGczLz0QWz56GMFyx6x6tClLG7IP27oIKwaLZ+oOtikrTArFzJLEHu2HrMM37aXqR/34ymP+PRchaFA02r5T3bDnlLpoXg36noTzxmZVMmLQi3NrSbpZsqQM2AN1J2eMdfMg6Vm2bGoD/i8QLEk+HA8gfjZUMJmwciTvTMpZFA0+I4TqO76RAUJ75gEr0bC4gV8ef+vmNL79UrZhbXJuK4fHZxHRxdaxLj++sZMls5ueis+1KVbzoJJ2bM8VU/DNOxPjE+m8+Yl5oun1W8cGN9fdSo3KqqF6V/Hml5HOZtnVF6tuLQSH4T3tD0sEh5wgpQmXnL/AuIoixD0JFLVgSYnob2MMofCgWW/0Ufb/yUW1Z9D87f/BH2e8rVuDEHm7GUhtAL7wq3NT0nyiHpHJDIROnY+l7u5Mue5lwuhIV0EdItKTCRn9AzpQG0/GtDgSbhdQnmrndyplz6PN4dUF3j5wiV44wIB8DpKub1VoVbGl63wsq2AE++L8wfwbB0g5UCLdC2MQkvarc2vWYhTx/SvPK6qxU5+iAMiWv6JKYhIjbvUO+vsvaidiLm3IraSRiWroVT7Tp0iFlO3AtoRTuxqFqDTwC8EGlp+k9iWU6eTzYYWgV88+D+vtg+L6oeXNiMlvsakegr4dbG7fZ5pXkIUT2LX0Y6yzjll4P1RAjzHLyUMQoVVj+AUYABCwewSBfAqx/BUBd5nyD+A8TvZBLfYvUtc7sVz5+zcJwcjUxHuVOBZyr8PeOh/EL0ZnVP++S+NiUncGSyB/i+AN0e1GE3I9LrQ4ukDSInqkWxCQ1BcM5hHCYvDRk8/JnDLy/uEmV+ptENmusfK0fJ7VDoHVgkCvUyQQVUH0ZLKUJrQMslzxLOlkU2NLx3pgnYqL5qrz8md95EFHIHen455CTBQFGwABMycEQVcASMdSe60GW3I24l8/JV2Ro6jATQH3HqKY7Oo5HrMZ9U4R3xSgy1+ld5MdTC+SZ0OkRMAaXVx1DRQvPK0rdw3r45Hd/PMS+jf1PU4SUS5pWwem7AEKNaVEnWQjQS2dAktIcgpgBfzZfQ9snJKYUcsArcA5NvLRSybnBOXvvRdY8NXI9qkrqoH/7YfXT/DEVhEDa/1pLlBO8seoDQOScxBZRWq0IckgSvcdLJ7+jsgEI2YcjaxKjnzZ6WJR0II2pgXYU33VfY0318Bs7vzwS4mRhe1YMFSVp5EvxYEWMOEMorqIAaWD6qKZmWC7zoTlhV2zFZ7YAuPuCSd8/EoaP37Wyuz7hfPzZ+dyolRJGnwChWD1pdpP7QwkvSUrsYE9qDIWiQCD8xBfhqjmMIEmIoUqgJDY7d0C9gSewBqM/RAruwvu/CmKsqvxsnyrrwKmUXTu/F1hFMIV1RzkMeL75TpRAvbPjYD8rNVbg8nBFWBF4jED8CPEZj3C5BGn4882dQ8QIIeoCQH0popoYwhBRFnF0Yl/hYlDW2d3yC9PAXuxA6eZchQoSgjNgVjcRDpyJO3RSVIp731L03Qk+agac46tSsU+4HxFjQvsdXUrM+gyl4b/tIKQQxBcCfkJKTS3BaAhaMDDEFJLzVcbokN2Qigd5BzyS9N1pMAZgBe3O4gdQSSPsQhPOKqUt1KXolADdqbzhFQEyw1PGbMylgfLOSYU4fFq2RkAJGDWZnw7XwE4xD8N+7l5kEsMLfhcWlH5+rFH6TxtLYrn7A9Q/tn87DouZ+gHD8tohZRb528Th6iFb/6EOzildDRsYLE5NKWVKAloe3tPYifP69Diul+Yi37ifSMvs6hilVP7//HPGQJifbp7YVEJeZ6lv58khEfXWnBsr4Xjz+G3rH5Eo3wS/wxKjB9MXP1jSecFpPxwrQAlA36Lmi3IZ14G1wHZyrTfsah1WLZjNjtJlx6aWewLJP01mXtCpAC8xbUXMxPq16M1YQlegZ05GWsbK05aYljFPhcExtgONvPYS+Ot1C12LMilDULySGw+G5hMv40SvRO8ZrQfR/GHvd+CgfrJiNksRaZlz5rS1mxx/TjTUrCkgEXTCnbnQkIl/GGf7liRI7eT0FPeVs9BQhsziRn7Vn2OiU7EKe9/GK3NuUK28/NLv4Q6vWi7Uyzan7RQFGcErurM/7bP9nkwhXplCFjYMvfwzoYj+YvaPROodCQXkYkNWdJvxoHs4WMfSoMASqbuSEMGyo4a9AcwCL0YPYTzgI8/AAetw+j4fuyvFKuzpfXarub7uXKwFXAq4EXAm4EnAl4ErAlYArAVcCrgRcCbgScCXgSsCVgCsBVwJnmgT+D1h31jyPG6P+AAAAAElFTkSuQmCC",
    "displayName": "Taboola",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Taboola Account ID",
    "simpleValueType": true,
    "name": "accountId",
    "type": "TEXT"
  },
  {
    "help": "You should always have one base pixel per account ID firing on each page.",
    "displayName": "Pixel Type",
    "simpleValueType": true,
    "name": "pixelType",
    "type": "RADIO",
    "radioItems": [
      {
        "displayValue": "Base pixel",
        "value": "page_view"
      },
      {
        "displayValue": "Event pixel",
        "value": "event"
      }
    ]
  },
  {
    "alwaysInSummary": true,
    "selectItems": [
      {
        "displayValue": "add_payment_info",
        "value": "add_payment_info"
      },
      {
        "displayValue": "add_to_cart",
        "value": "add_to_cart"
      },
      {
        "displayValue": "add_to_wishlist",
        "value": "add_to_wishlist"
      },
      {
        "displayValue": "app_install",
        "value": "app_install"
      },
      {
        "displayValue": "complete_registration",
        "value": "complete_registration"
      },
      {
        "displayValue": "lead",
        "value": "lead"
      },
      {
        "displayValue": "make_purchase",
        "value": "make_purchase"
      },
      {
        "displayValue": "search",
        "value": "search"
      },
      {
        "displayValue": "start_checkout",
        "value": "start_checkout"
      },
      {
        "displayValue": "view_content",
        "value": "view_content"
      },
      {
        "displayValue": "[Custom]",
        "value": "custom"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "type": "EQUALS",
        "paramValue": "event"
      }
    ],
    "displayName": "Event Name",
    "simpleValueType": true,
    "name": "eventName",
    "type": "SELECT",
    "subParams": [
      {
        "valueValidators": [
          {
            "args": [
              "^[a-zA-Z0-9_-]+$"
            ],
            "enablingConditions": [],
            "errorMessage": "The event name must consist only of alphanumeric characters, underscores, and/or dashes.",
            "type": "REGEX"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "eventName",
            "type": "EQUALS",
            "paramValue": "custom"
          }
        ],
        "displayName": "Custom Event Name",
        "simpleValueType": true,
        "name": "customEventName",
        "type": "TEXT"
      }
    ]
  },
  {
    "displayName": "Custom Parameters",
    "name": "customParameters",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "help": "Add the <code>item-url</code> parameter to specify a custom page URL for your page_view calls. This is useful with single-page applications. See <a href=\"https://help.taboola.com/hc/en-us/articles/360007856794-Developer-Notes\">this documentation</a> for more information.",
        "simpleValueType": true,
        "name": "addItemUrl",
        "checkboxText": "item-url",
        "type": "CHECKBOX",
        "subParams": [
          {
            "enablingConditions": [
              {
                "paramName": "addItemUrl",
                "type": "EQUALS",
                "paramValue": true
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "simpleValueType": true,
            "name": "itemUrl",
            "type": "TEXT"
          }
        ]
      },
      {
        "help": "Add the <code>revenue</code> parameter to specify a custom conversion value for this event. See <a href=\"https://help.taboola.com/hc/en-us/articles/360009027493-Adding-Values-to-Conversions\">this documentation</a> for more information.",
        "simpleValueType": true,
        "name": "addRevenue",
        "checkboxText": "revenue",
        "type": "CHECKBOX",
        "subParams": [
          {
            "enablingConditions": [
              {
                "paramName": "addRevenue",
                "type": "EQUALS",
                "paramValue": true
              }
            ],
            "valueValidators": [
              {
                "args": [
                  "^[0-9]+(\\.[0-9]+)?$"
                ],
                "errorMessage": "The value must be numerical (integer or floating point).",
                "type": "REGEX"
              }
            ],
            "simpleValueType": true,
            "name": "revenue",
            "type": "TEXT"
          }
        ]
      },
      {
        "help": "Add the <code>currency</code> parameter to specify a currency for the value passed in the \"revenue\" parameter. See <a href=\"https://help.taboola.com/hc/en-us/articles/360009027493-Adding-Values-to-Conversions\">this documentation</a> for a list of supported currencies.",
        "simpleValueType": true,
        "name": "addCurrency",
        "checkboxText": "currency",
        "type": "CHECKBOX",
        "subParams": [
          {
            "enablingConditions": [
              {
                "paramName": "addCurrency",
                "type": "EQUALS",
                "paramValue": true
              }
            ],
            "valueValidators": [
              {
                "args": [
                  "^[a-zA-Z]{3}$"
                ],
                "errorMessage": "The value must be a three-letter currency code.",
                "type": "REGEX"
              }
            ],
            "simpleValueType": true,
            "name": "currency",
            "type": "TEXT"
          }
        ]
      },
      {
        "help": "Use this field to add other parameters to the call. Refer to the <a href=\"https://help.taboola.com/hc/en-us/articles/360003469854-Taboola-Pixel-Overview\">Taboola Pixel documentation</a> for details on what other parameters are supported.",
        "simpleValueType": true,
        "name": "addOther",
        "checkboxText": "Other parameters",
        "type": "CHECKBOX",
        "subParams": [
          {
            "valueValidators": [
              {
                "errorMessage": "You must add at least one parameter.",
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "addOther",
                "type": "EQUALS",
                "paramValue": true
              }
            ],
            "name": "otherParams",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Parameter name",
                "name": "name",
                "isUnique": true,
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Parameter value",
                "name": "value",
                "type": "TEXT"
              }
            ],
            "type": "SIMPLE_TABLE"
          }
        ]
      }
    ]
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_tfa"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__tfa_pixel_init"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.taboola.com/libtrc/unip/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require necessary APIs
const createQueue = require('createQueue');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const makeTableMap = require('makeTableMap');
const log = require('logToConsole');
const encodeUriComponent = require('encodeUriComponent');

// Generate the global and local variables
const initPixelPush = createQueue('__tfa_pixel_init');
const initPixel = copyFromWindow('__tfa_pixel_init');
const _tfa = createQueue('_tfa');

// Capture user input from the tag
const accountId = data.accountId;
const pixelType = data.pixelType;
const eventName = data.eventName === 'custom' ? data.customEventName : data.eventName;
const otherParams = data.otherParams ? makeTableMap(data.otherParams, 'name', 'value') : {};

// Build the payload for the _tfa call
const params = {
  notify: 'event',
  id: accountId
};
if (data.itemUrl) params['item-url'] = data.itemUrl;
if (data.revenue) params.revenue = data.revenue;
if (data.currency) params.currency = data.currency;
for (let prop in otherParams) {
  params[prop] = otherParams[prop];
}

// If page_view hasn't been sent for the ID yet, do it now
if (initPixel.indexOf(accountId) === -1) {
  const pvParams = {
    notify: 'event',
    id: accountId,
    name: 'page_view'
  };
  if (data.itemUrl) pvParams['item-url'] = data.itemUrl;
  _tfa(pvParams);
  initPixelPush(accountId);
}

// If the type was "event", dispatch it here
if (pixelType === 'event') {
  params.name = eventName;
  _tfa(params);
}

// Load the Taboola script if not already loaded
injectScript('https://cdn.taboola.com/libtrc/unip/' + encodeUriComponent(accountId) + '/tfa.js', data.gtmOnSuccess, data.gtmOnFailure, '_tfa_script');